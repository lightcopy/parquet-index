#!/bin/bash

bin="`dirname "$0"`"
ROOT_DIR="`cd "$bin/../"; pwd`"

if [[ -z "$SPARK_HOME" ]]; then
  echo "SPARK_HOME is not set"
  exit 1
fi

# Find jar to test, should be in target directory, fail if no jar exists
SCALA_VERSION="2.11"

SPARK_JARS=""
PYFILES=""
for jar in $(find $ROOT_DIR/target/scala-$SCALA_VERSION -name "*.jar" -type f); do
  SPARK_JARS="$jar,$SPARK_JARS"
  PYFILES="$jar:$PYFILES"
done

if [[ -z "$SPARK_JARS" ]]; then
  echo "At least one jar is required to run tests, run 'sbt package' to create jar"
  exit 1
fi

LIBS=""
for lib in $(find $SPARK_HOME/python/lib -name "*.zip" -type f); do
  LIBS=$LIBS:$lib
done

export PYSPARK_SUBMIT_ARGS="--jars $SPARK_JARS pyspark-shell"
export PYTHONPATH=$PYTHONPATH:$SPARK_HOME/python:$PYFILES:$LIBS

python $ROOT_DIR/python/run_tests.py
